<div class="container mb-3">
    <div class="top-level-communities">
    <!-- Affichage des communautés principales (hérité du parent) -->
    <ng-container *ngVar="communitiesRD$ | async as communitiesRD">
        <ds-loading *ngIf="communitiesRD?.isLoading" message="{{'loading.default' | translate}}"></ds-loading>
    </ng-container>
        <h1 class="title mt-2 mb-3">{{ 'communityList.title' | translate }}</h1>
        <!-- Indicateur de chargement des sous-communautés -->
        <div *ngIf="isLoadingSubcommunities" class="text-center py-4">
        <ds-loading [message]="'subcommunities.loading' | translate"></ds-loading>
        </div>

        <!-- Grille des sous-communautés -->
        <div *ngIf="!isLoadingSubcommunities && displayedSouscommunities.length > 0" class="row g-4">
        <div *ngFor="let subcommunity of displayedSouscommunities; trackBy: trackBySubcommunityId" class="col-12 col-sm-6 col-lg-4">
            <div class="card subcommunity-card h-100 shadow-sm border-bib">
            <!-- Image vedette -->
            <div *ngIf="hasVedette(subcommunity)" class="card-img-top-container position-relative overflow-hidden">
                <img 
                [src]="subcommunity.vedette" 
                [alt]="subcommunity.title"
                class="card-img-top w-100 border-bib"
                loading="lazy"
                style="height: 200px; object-fit: cover;">
            </div>
            
            <!-- Placeholder si pas d'image -->
            <div *ngIf="!hasVedette(subcommunity)" class="card-img-top-container position-relative border-bib overflow-hidden bg-light d-flex align-items-center justify-content-center" style="height: 200px;">

            </div>
            
            <div class="card-body d-flex flex-column">
                <!-- Titre -->
                <h3 class="card-title mb-2">
                <a 
                    [routerLink]="getSubcommunityUrl(subcommunity)"
                    class="text-decoration-none text-primary">
                    {{ subcommunity.title }}
                </a>
                </h3>
                
                <!-- Badge de la communauté parente -->
                <div *ngIf="subcommunity.parentCommunityName" class="mb-2">
                <small class="badge bg-info text-white">
                    {{ subcommunity.parentCommunityName }}
                </small>
                </div>
                
                <!-- Description -->
                <div *ngIf="hasDescription(subcommunity)" class="card-text flex-grow-1 mb-3">
                    <p class="text-muted small mb-0 height-5">
                        {{ subcommunity.description | slice:0:150 }}
                        <span *ngIf="subcommunity.description.length > 150">...</span>
                    </p>
                </div>
                
                <!-- Ajout du mt-auto pour pousser le bouton en bas -->
                <div class="mt-auto">
                    <a [routerLink]="getSubcommunityUrl(subcommunity)" class="btn bib-left-arrow">
                        {{ 'collspec.collection.decouvrir' | translate }}
                    </a>
                </div>
            </div>
            </div>
        </div>
        </div>
        
        <!-- Bouton "Voir plus" -->
        <div *ngIf="hasMore && !isLoadingSubcommunities" class="text-center mt-5">
        <button 
            type="button"
            class="btn btn-primary px-4"
            (click)="loadMore()"
            [attr.aria-label]="'collection.edit.item.authorizations.load-more-button' | translate">
            <i class="bi bi-plus-circle me-2"></i>
            {{ 'collection.edit.item.authorizations.load-more-button' | translate }}
            <span class="badge bg-light text-dark bib-circle">
            {{ allSouscommunities.length - displayedSouscommunities.length }}
            </span>
        </button>
        </div>

        <!-- Message si aucune sous-communauté après recherche -->
        <div *ngIf="!isLoadingSubcommunities && displayedSouscommunities.length === 0 && allSouscommunities.length > 0" class="text-center py-5">
        <div class="alert alert-info">
            {{ 'subcommunities.noResults' | translate }}
        </div>
        </div>
    </div>
    <!-- Message si aucune sous-communauté du tout -->
    <div *ngIf="!isLoadingSubcommunities && allSouscommunities.length === 0" class="text-center py-5">
        <div class="alert alert-secondary">
        <i class="bi bi-folder-x me-2"></i>
        {{ 'subcommunities.empty' | translate }}
        </div>
    </div>
</div>